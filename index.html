<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶“å…¸è²ªé£Ÿè›‡éŠæˆ² (æ‰‹æ©Ÿè§¸æ§æ”¯æ´)</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #2c3e50;
            font-family: 'Arial', sans-serif;
            color: white;
            overflow: hidden;
            /* è®“æ‰‹æ©Ÿç€è¦½å™¨ä¿æŒåœ¨å–®ä¸€ç•«é¢ï¼Œé¿å…æ²å‹• */
            touch-action: manipulation; 
        }

        h1 {
            color: #ecf0f1;
            margin-bottom: 20px;
        }

        #gameCanvas {
            border: 5px solid #bdc3c7;
            background-color: #34495e;
        }

        #scoreBoard {
            margin-top: 15px;
            font-size: 1.5em;
            color: #f1c40f;
            min-height: 1.5em;
        }
        
        #message {
            margin-top: 20px;
            font-size: 1.2em;
            color: #e74c3c;
            display: none;
        }

        #gameStatus {
            margin-top: 10px;
            font-size: 1em;
            color: #95a5a6;
            min-height: 1em;
        }

        /* --- å½ˆå‡ºå°è©±æ¡†æ¨£å¼ (ä¸è®Š) --- */
        #dialogBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #3498db;
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 100;
            text-align: center;
            display: none;
            max-width: 80%;
            animation: fadeIn 0.3s;
        }

        /* --- è™›æ“¬æŒ‰éµæ§åˆ¶å€æ¨£å¼ --- */
        #control-panel {
            display: grid;
            grid-template-areas: 
                ". up ."
                "left . right"
                ". down .";
            width: 150px; /* æ§åˆ¶æ•´å€‹ D-Pad å€åŸŸå¯¬åº¦ */
            height: 150px; /* æ§åˆ¶æ•´å€‹ D-Pad å€åŸŸé«˜åº¦ */
            margin-top: 30px;
            user-select: none; /* é˜²æ­¢æ‰‹æ©Ÿé¸å–æ–‡å­— */
        }

        .dpad-button {
            background-color: #3498db; /* è—è‰²æŒ‰éˆ• */
            color: white;
            border: 2px solid #2980b9;
            border-radius: 5px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.1s;
            padding: 10px;
        }
        
        .dpad-button:active {
            background-color: #1a6096; /* æŒ‰ä¸‹æ™‚è®Šæ·± */
        }

        #up-btn { grid-area: up; }
        #down-btn { grid-area: down; }
        #left-btn { grid-area: left; }
        #right-btn { grid-area: right; }
    </style>
</head>
<body>

    <h1>è²ªé£Ÿè›‡å¤§ä½œæˆ° (è‡ªè¨‚å¢ç›Šç‰ˆ)</h1>
    <canvas id="gameCanvas" width="400" height="400"></canvas>
    <div id="scoreBoard">åˆ†æ•¸ï¼š0</div>
    <div id="gameStatus"></div>
    <div id="message">éŠæˆ²çµæŸï¼æŒ‰ R é‡æ–°é–‹å§‹ã€‚</div>

    <div id="control-panel">
        <div id="up-btn" class="dpad-button">ä¸Š</div>
        <div id="left-btn" class="dpad-button">å·¦</div>
        <div id="right-btn" class="dpad-button">å³</div>
        <div id="down-btn" class="dpad-button">ä¸‹</div>
    </div>

    <div id="dialogBox">
        <h2 id="dialogTitle">å¢ç›Šæ•ˆæœå•Ÿå‹•ï¼</h2>
        <p id="dialogEffect"></p>
        <p id="dialogTimer"></p>
    </div>

    <script>
        // --- HTML å…ƒç´  ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreBoard = document.getElementById('scoreBoard');
        const gameStatus = document.getElementById('gameStatus');
        const message = document.getElementById('message');
        const dialogBox = document.getElementById('dialogBox');
        
        // æ–°å¢æŒ‰éˆ•å…ƒç´ 
        const upBtn = document.getElementById('up-btn');
        const downBtn = document.getElementById('down-btn');
        const leftBtn = document.getElementById('left-btn');
        const rightBtn = document.getElementById('right-btn');


        // --- éŠæˆ²è¨­å®š ---
        const gridSize = 20; 
        const tileCount = canvas.width / gridSize;
        const initialSpeed = 120; // åŸºæœ¬é€Ÿåº¦ (è¶Šå°è¶Šå¿«)
        
        // --- å¢ç›ŠæŠ€èƒ½æ™‚é•· (ä»¥éŠæˆ²å¹€æ•¸/Tickè¨ˆç®—) ---
        const INVINCIBLE_DURATION = 50; // ç´„ 6 ç§’
        const MULTIPLIER_DURATION = 40; // ç´„ 4.8 ç§’
        const SLOWDOWN_DURATION = 35;  // ç´„ 4.2 ç§’

        // --- éŠæˆ²ç‹€æ…‹ ---
        let snake = [];
        let xVelocity = 1; 
        let yVelocity = 0;
        let score = 0;
        let gameSpeed = initialSpeed;
        let gameLoopInterval;

        // --- éŠæˆ²ç‰©å“ç‹€æ…‹ ---
        let redApple = {};
        let goldenApple = {};
        let shieldPotion = {};
        let scoreStar = {};
        let mushroom = {};

        // --- å¢ç›Šç‹€æ…‹èˆ‡è¨ˆæ™‚å™¨ ---
        let isInvincible = false;
        let scoreMultiplier = 1;

        let invincibleTimer = 0;
        let multiplierTimer = 0;
        let slowdownTimer = 0;

        // --- æ ¸å¿ƒéŠæˆ²å‡½æ•¸ ---

        function resetGame() {
            snake = [{x: 10, y: 10}]; 
            xVelocity = 1;
            yVelocity = 0;
            score = 0;
            gameSpeed = initialSpeed;
            isInvincible = false;
            scoreMultiplier = 1;
            invincibleTimer = 0;
            multiplierTimer = 0;
            slowdownTimer = 0;

            // ***** ç¨€æœ‰ç‰©å“å‡ºç¾æ©Ÿç‡è¨­ç‚º 100% *****
            const guaranteedProb = 1.0; 

            redApple = createItem('redApple');
            goldenApple = createItem('goldenApple', guaranteedProb); // 100% æ©Ÿç‡
            shieldPotion = createItem('shieldPotion', guaranteedProb); // 100% æ©Ÿç‡
            scoreStar = createItem('scoreStar', guaranteedProb); // 100% æ©Ÿç‡
            mushroom = createItem('mushroom', guaranteedProb); // 100% æ©Ÿç‡
            
            scoreBoard.textContent = 'åˆ†æ•¸ï¼š0';
            gameStatus.textContent = '';
            message.style.display = 'none';
            dialogBox.style.display = 'none';
            
            clearInterval(gameLoopInterval);
            gameLoopInterval = setInterval(gameLoop, gameSpeed);
        }
        
        // ç”ŸæˆéŠæˆ²ç‰©å“
        function createItem(type, probability = 1) {
            if (Math.random() > probability) {
                return null;
            }
            let newItem;
            let maxAttempts = 100;
            let attempts = 0;
            do {
                newItem = {
                    x: Math.floor(Math.random() * tileCount),
                    y: Math.floor(Math.random() * tileCount),
                    type: type
                };
                attempts++;
            } while ((isOccupied(newItem) || isItemOverlapping(newItem)) && attempts < maxAttempts);

            return attempts < maxAttempts ? newItem : null;
        }

        // æª¢æŸ¥åº§æ¨™æ˜¯å¦è¢«ä½”ç”¨
        function isOccupied(pos) {
            return snake.some(segment => segment.x === pos.x && segment.y === pos.y);
        }
        function isItemOverlapping(pos) {
            const items = [redApple, goldenApple, shieldPotion, scoreStar, mushroom].filter(i => i);
            return items.some(item => item && item.x === pos.x && item.y === pos.y);
        }

        // æ›´æ–°éŠæˆ²é€Ÿåº¦
        function updateSpeed(newSpeed) {
            if (newSpeed !== gameSpeed) {
                gameSpeed = newSpeed;
                clearInterval(gameLoopInterval);
                gameLoopInterval = setInterval(gameLoop, gameSpeed);
            }
        }
        
        // å½ˆå‡ºå¢ç›Šæ•ˆæœå°è©±æ¡†
        function showPowerUpDialog(title, effect, durationTicks) {
            const durationSeconds = Math.ceil(durationTicks * initialSpeed / 1000); 

            document.getElementById('dialogTitle').textContent = title;
            document.getElementById('dialogEffect').textContent = effect;
            document.getElementById('dialogTimer').textContent = `æŒçºŒ ${durationSeconds} ç§’`;
            
            dialogBox.style.display = 'block';

            setTimeout(() => {
                dialogBox.style.display = 'none';
            }, 2000); 
        }

        // è™•ç†ç§»å‹•é‚è¼¯ (æ•´åˆéµç›¤å’ŒæŒ‰éˆ•è¼¸å…¥)
        function changeDirection(key) {
             switch(key) {
                case 'ArrowUp': 
                case 'w':
                case 'up': // æ–°å¢æŒ‰éˆ•æŒ‡ä»¤
                    if (yVelocity !== 1) { xVelocity = 0; yVelocity = -1; }
                    break;
                case 'ArrowDown': 
                case 's':
                case 'down': // æ–°å¢æŒ‰éˆ•æŒ‡ä»¤
                    if (yVelocity !== -1) { xVelocity = 0; yVelocity = 1; }
                    break;
                case 'ArrowLeft': 
                case 'a':
                case 'left': // æ–°å¢æŒ‰éˆ•æŒ‡ä»¤
                    if (xVelocity !== 1) { xVelocity = -1; yVelocity = 0; }
                    break;
                case 'ArrowRight': 
                case 'd':
                case 'right': // æ–°å¢æŒ‰éˆ•æŒ‡ä»¤
                    if (xVelocity !== -1) { xVelocity = 1; yVelocity = 0; }
                    break;
                case 'r': 
                case 'R':
                    if (message.style.display === 'block') { resetGame(); }
                    break;
            }
        }

        // --- æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨ ---
        function addTouchControl(button, direction) {
            // è™•ç†æ‰‹æ©Ÿè§¸æ§
            button.addEventListener('touchstart', (e) => {
                e.preventDefault(); // é˜²æ­¢è§¸æ§æ™‚é é¢æ²å‹•
                changeDirection(direction);
            });
            // è™•ç†æ»‘é¼ é»æ“Š (é›»è…¦ä¸Šä¹Ÿå¯ä»¥ç”¨)
            button.addEventListener('click', () => {
                changeDirection(direction);
            });
        }

        addTouchControl(upBtn, 'up');
        addTouchControl(downBtn, 'down');
        addTouchControl(leftBtn, 'left');
        addTouchControl(rightBtn, 'right');
        // --- æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨çµæŸ ---


        // æª¢æŸ¥ä¸¦æ‡‰ç”¨å¢ç›Šæ•ˆæœ
        function checkPowerUp(head) {
            const guaranteedProb = 1.0;
            
            // 1. å®ˆè­·è—¥æ°´ -> æ—æ™‰ä½‘çœ‹netflixä¸ä»˜éŒ¢ (Invincibility)
            if (shieldPotion && head.x === shieldPotion.x && head.y === shieldPotion.y) {
                isInvincible = true;
                invincibleTimer = INVINCIBLE_DURATION;
                shieldPotion = createItem('shieldPotion', guaranteedProb); 
                showPowerUpDialog("æ—æ™‰ä½‘çœ‹netflixä¸ä»˜éŒ¢", "ğŸ›¡ï¸ æš«æ™‚ç„¡è¦–ç¢°æ’ï¼", INVINCIBLE_DURATION);
                return true;
            } 
            // 2. åˆ†æ•¸ä¹‹æ˜Ÿ -> æ—å¾·æ‡·æ•¸å­¸1åˆ† (Score Multiplier)
            else if (scoreStar && head.x === scoreStar.x && head.y === scoreStar.y) {
                scoreMultiplier = 2;
                multiplierTimer = MULTIPLIER_DURATION;
                scoreStar = createItem('scoreStar', guaranteedProb); 
                showPowerUpDialog("æ—å¾·æ‡·æ•¸å­¸1åˆ†", "â­ æ‰€æœ‰å¾—åˆ† X 2ï¼", MULTIPLIER_DURATION);
                return true;
            } 
            // 3. å¢ç›Šè˜‘è‡ -> è¨±å“è¬™é»‘é»‘åŠ›é‡ (Slowdown)
            else if (mushroom && head.x === mushroom.x && head.y === mushroom.y) {
                updateSpeed(250); // æ…¢é€Ÿ (250ms)
                slowdownTimer = SLOWDOWN_DURATION;
                mushroom = createItem('mushroom', guaranteedProb); 
                showPowerUpDialog("è¨±å“è¬™é»‘é»‘åŠ›é‡", "ğŸŸ£ é€Ÿåº¦æ¸›æ…¢ï¼Œæ›´å®¹æ˜“æ“ä½œã€‚", SLOWDOWN_DURATION);
                return true;
            }
            return false;
        }

        function gameLoop() {
            // --- 1. è™•ç†è¨ˆæ™‚å™¨èˆ‡ç‹€æ…‹é‡ç½® ---
            let statusText = '';
            
            if (invincibleTimer > 0) {
                invincibleTimer--;
                if (invincibleTimer === 0) { isInvincible = false; }
                else { statusText += `ğŸ›¡ï¸ çœ‹Nä¸ä»˜ (${Math.ceil(invincibleTimer * gameSpeed / 1000)}s) `; }
            }

            if (multiplierTimer > 0) {
                multiplierTimer--;
                if (multiplierTimer === 0) { scoreMultiplier = 1; }
                else { statusText += `â­ æ•¸å­¸1åˆ† X${scoreMultiplier} (${Math.ceil(multiplierTimer * gameSpeed / 1000)}s) `; }
            }
            
            if (slowdownTimer > 0) {
                slowdownTimer--;
                if (slowdownTimer === 0) { updateSpeed(initialSpeed); }
                else { statusText += `ğŸŸ£ é»‘é»‘åŠ›é‡ (${Math.ceil(slowdownTimer * gameSpeed / 1000)}s) `; }
            }
            gameStatus.textContent = statusText;


            // --- 2. ç§»å‹•è›‡ ---
            const head = {x: snake[0].x + xVelocity, y: snake[0].y + yVelocity};
            
            // --- 3. æª¢æŸ¥ç¢°æ’ ---
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount || isOccupied(head)) {
                if (!isInvincible) {
                    gameOver();
                    return;
                }
            }

            // --- 4. å°‡æ–°é ­éƒ¨åŠ å…¥è›‡èº« ---
            snake.unshift(head);
            let ate = false;

            // --- 5. æª¢æŸ¥åƒåˆ°å¢ç›Šç‰©å“ ---
            ate = checkPowerUp(head);


            // --- 6. æª¢æŸ¥åƒåˆ°è˜‹æœ ---
            if (!ate) { 
                if (redApple && head.x === redApple.x && head.y === redApple.y) {
                    score += 1 * scoreMultiplier;
                    redApple = createItem('redApple');
                    ate = true;
                } else if (goldenApple && head.x === goldenApple.x && head.y === goldenApple.y) {
                    score += 5 * scoreMultiplier;
                    goldenApple = createItem('goldenApple', 1.0); // 100% æ©Ÿç‡é‡æ–°ç”Ÿæˆ
                    ate = true;
                }
            }
            
            // --- 7. æ›´æ–°é•·åº¦èˆ‡åˆ†æ•¸ ---
            scoreBoard.textContent = `åˆ†æ•¸ï¼š${score}`;

            if (!ate) {
                snake.pop(); 
            }
            
            // --- 8. ç¹ªè£½ç•«é¢ ---
            draw();
        }

        // ç¹ªè£½éŠæˆ²ç•«é¢ (ä¸è®Š)
        function draw() {
            // æ¸…ç©ºç•«å¸ƒ
            ctx.fillStyle = '#34495e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç¹ªè£½è›‡
            ctx.fillStyle = '#2ecc71'; 
            snake.forEach(segment => {
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 1, gridSize - 1);
            });
            
            // ç¹ªè£½è›‡é ­ - ç„¡æ•µæ™‚è®Šè‰²
            if (isInvincible) {
                ctx.fillStyle = '#f39c12'; // æ©™è‰²/é‡‘è‰²é ­éƒ¨
                ctx.fillRect(snake[0].x * gridSize, snake[0].y * gridSize, gridSize - 1, gridSize - 1);
            }

            // ç¹ªè£½ç‰©å“
            // ğŸŸ¥ ç´…è˜‹æœ (ç´…è‰²)
            if (redApple) {
                ctx.fillStyle = '#e74c3c'; 
                ctx.fillRect(redApple.x * gridSize, redApple.y * gridSize, gridSize - 1, gridSize - 1);
            }
            // ğŸŸ¡ é»ƒé‡‘è˜‹æœ (é‡‘è‰²)
            if (goldenApple) {
                ctx.fillStyle = '#ffd700'; 
                ctx.fillRect(goldenApple.x * gridSize, goldenApple.y * gridSize, gridSize - 1, gridSize - 1);
            }
            // ğŸŸ£ å¢ç›Šè˜‘è‡ (ç´«è‰²)
            if (mushroom) {
                ctx.fillStyle = '#9b59b6'; 
                ctx.fillRect(mushroom.x * gridSize, mushroom.y * gridSize, gridSize - 1, gridSize - 1);
            }
            // ğŸ›¡ï¸ å®ˆè­·è—¥æ°´ (è—è‰²/é’è‰²)
            if (shieldPotion) {
                ctx.fillStyle = '#1abc9c';
                ctx.fillRect(shieldPotion.x * gridSize, shieldPotion.y * gridSize, gridSize - 1, gridSize - 1);
            }
            // â­ åˆ†æ•¸ä¹‹æ˜Ÿ (ç™½è‰²/é»ƒè‰²)
            if (scoreStar) {
                ctx.fillStyle = '#ecf0f1';
                ctx.fillRect(scoreStar.x * gridSize, scoreStar.y * gridSize, gridSize - 1, gridSize - 1);
            }
        }

        // è™•ç†éµç›¤è¼¸å…¥ (ä½¿ç”¨çµ±ä¸€çš„ changeDirection å‡½æ•¸)
        document.addEventListener('keydown', function(event) {
            changeDirection(event.key);
        });

        function gameOver() {
            clearInterval(gameLoopInterval);
            message.textContent = `éŠæˆ²çµæŸï¼æœ€çµ‚å¾—åˆ†: ${score}ã€‚æŒ‰ R é‡æ–°é–‹å§‹ã€‚`;
            message.style.display = 'block';
        }

        // å•Ÿå‹•éŠæˆ²
        resetGame();

    </script>
</body>
</html>
